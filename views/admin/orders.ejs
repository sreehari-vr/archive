<%- include("../../views/partials/admin/header") %>

  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
  </head>
  <div class="content-header">
    <div>
      <h2 class="content-title card-title">Orders</h2>
    </div>
  </div>
  <header class="card-header text-center mb-20 d-flex gap-5">
    <form action="/admin/orders" method="get" class="d-inline">
      <div class="input-group input-group-sm border border-1 border-grey rounded-pill"
        style="width: 500px; margin-left: 230px;">
        <input type="text" class="form-control border-0 rounded-pill" placeholder="Search orders or users"
          name="search">
        <button class="btn border-0" type="submit">Search</button>
      </div>
    </form>
  </header>
  <div class="right mt-5">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Product(s)</th>
          <th>Total Amount</th>
          <th>Payment Method</th>
          <th>Order Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% orders.forEach(order=> { %>
          <tr>
            <td>
              <%= order._id %>
            </td>
            <td>
              <%= order.userId ? order.userId.name : "Unknown User" %>
            </td>
            <td>
              <% order.items.forEach(item=> { %>
                <div class="mb-2">
                  - <%= item.productId.name %> (Qty: <%= item.quantity %>, ₹<%= item.price %>)<br>
                        <small>Status: <%= item.status %></small>
                        <form class="update-status-form" data-order-id="<%= order._id %>" data-item-id="<%= item._id %>"
                          method="POST" style="display:inline;">
                          <select name="status" class="status-select">
                            <option disabled selected>Update Status</option>
                            <option value="Pending" <%=item.status==='Pending' ? 'selected' : '' %>>Pending</option>
                            <option value="Shipped" <%=item.status==='Shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="Cancelled" <%=item.status==='Cancelled' ? 'selected' : '' %>>Cancelled</option>
                            <option value="Returned" <%=item.status==='Returned' ? 'selected' : '' %>>Returned</option>
                          </select>
                        </form>

                </div>
                <% }); %>
            </td>
            <td>₹<%= order.totalAmount %>
            </td>
            <td>
              <%= order.paymentMethod %>
            </td>
            <td>
              <%= order.orderDate.toDateString() %>
            </td>
            <td>
              <a href="/admin/orders/<%= order._id %>">View Order</a>
            </td>
          </tr>
          <% }); %>
      </tbody>
    </table>
  </div>

  <div class="container mt-3">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-20" style="margin-right: 200px;">
        <% for(let i=1; i <=totalPages; i++) { %>
          <li class="page-item <%= (i === currentPage) ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>" aria-current="<%= (i === currentPage) ? 'page' : '' %>">
              <%= i %>
            </a>
          </li>
          <% } %>
      </ul>
    </nav>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
  $(document).ready(function () {
    $(".status-select").change(function (e) {
      e.preventDefault();
      const form = $(this).closest("form");
      const status = $(this).val();
      const orderId = form.data("order-id");
      const itemId = form.data("item-id");

      Swal.fire({
        title: "Are you sure?",
        text: `Change status to "${status}"?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes!"
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/admin/orders/${orderId}/${itemId}`,
            method: "POST",
            data: { status: status },
            success: (response) => {
              Swal.fire("Updated!", response.message, "success").then(() => {
                location.reload(); // Reload the page to reflect changes
              });
            },
            error: (err) => {
              Swal.fire("Error!", err.responseJSON?.error || "An error occurred", "error");
            },
          });
        } else {
          // Revert the dropdown to its original value if the user cancels
          $(this).val($(this).data("original-status"));
        }
      });
    });

    // Save original value on focus
    $(".status-select").focus(function () {
      $(this).data("original-status", $(this).val());
    });
  });
</script>
